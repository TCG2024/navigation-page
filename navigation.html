async function generatePTWNumber() {
  const currentYear = new Date().getFullYear();
  const prefix = `${currentYear}-G-`;

  try {
    const params = {
      TableName: 'GeneralPTWIssue',
      FilterExpression: 'begins_with(ptwNumber, :prefix)',
      ExpressionAttributeValues: { ':prefix': prefix }
    };
    const result = await dynamodb.scan(params).promise();

    const ptwArray = result.Items.map(item => item.ptwNumber);
    ptwArray.sort((a, b) => parseInt(a.split('-')[2]) - parseInt(b.split('-')[2]));

    const lastNumber = ptwArray.length > 0 ? parseInt(ptwArray[ptwArray.length - 1].split('-')[2]) : 0;
    const newPTWNumber = `${prefix}${lastNumber + 1}`;

    document.getElementById('ptwNumber').value = newPTWNumber;
  } catch (error) {
    console.error('Error generating PTW number:', error);
  }
}

//*******************************************************************************************************************

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}


//*******************************************************************************************************************

async function savePTWFormData(event) {
  event.preventDefault();

  if (!confirm('Do you want to generate the General PTW?')) {
    return;
  }

  const ptwForm = document.getElementById('ptwForm');
  let ptwNumber = document.getElementById('ptwNumber').value;

  if (!ptwNumber) {
    alert('PTW Number is missing. Please make sure it is generated.');
    return;
  }

  showLoading();

  try {
    // Helper function to get the displayed text of the selected option in a dropdown
    const getSelectText = (elementId) => {
      const selectElement = document.getElementById(elementId);
      if (selectElement && selectElement.options) {
        return selectElement.options[selectElement.selectedIndex].text; // Get the displayed text
      }
      return '';
    };

    // General Information
    const generalInfo = {
      ptwNumber: ptwNumber,
      date: document.getElementById('date').value,
      issueTimeFrom: document.getElementById('issueTimeFrom').value,
      issueTimeTo: document.getElementById('issueTimeTo').value,
      requestingDepartment: document.getElementById('requestingDepartment').value,
      jobLocation: document.getElementById('jobLocation').value,
      jobDescription: document.getElementById('jobDescription').value,
      requestingPersonnel: getSelectText('requestingPersonnel'), // Fetch displayed text
      contractor: getSelectText('contractor'), // Fetch displayed text
      contractorSupervisor: document.getElementById('contractorSupervisor').value,
    };

    // Check Points
    const checkPoints = {
      cleanedWashed: document.getElementById('cleanedWashed').value,
      electricalConnection: document.getElementById('electricalConnection').value,
      fusesRemoved: {
        status: document.getElementById('fusesRemoved').value,
        electricianSign: document.getElementById('electricianSign').value,
      },
      equipmentIsolated: document.getElementById('equipmentIsolated').value,
      equipmentCleaned: document.getElementById('equipmentCleaned').value,
      jobAreaCondoning: document.getElementById('jobAreaCondoning').value,
      cautionaryNotice: document.getElementById('cautionaryNotice').value,
      staffInformed: document.getElementById('staffInformed').value,
      scrapRemoved: document.getElementById('scrapRemoved').value,
      securityInformed: {
        status: document.getElementById('securityInformed').value,
        securityName: document.getElementById('securityName').value,
      },
    };

    // Equipment Used
    const equipmentUsed = [];
    document.querySelectorAll('input[name="equipmentUsed"]:checked').forEach((checkbox) => {
      equipmentUsed.push(checkbox.value);
    });

    // Signatures
    const getCanvasSignature = (canvasId) => {
      const canvas = document.getElementById(canvasId);
      return canvas ? canvas.toDataURL() : '';
    };

    const signatures = {
      requester: {
        name: document.getElementById('requesterSignatureSelect').value, // Fetch displayed text
        signature: getCanvasSignature('requesterSignatureCanvas'),
      },
      issuer: {
        name: document.getElementById('issuerName').value,
        signature: getCanvasSignature('issuerSignatureCanvas'),
      },
      ehs: {
        name: getSelectText('ehsSignatureSelect'), // Fetch displayed text
        signature: getCanvasSignature('ehsSignatureCanvas'),
      },
      contractorSupervisor: {
        name: document.getElementById('contractorSupervisorsignature').value,
        signature: getCanvasSignature('contractorSupervisorSignatureCanvas'),
      },
    };

    // Camera Image
    const capturedImage = captureImage(); // Assume this function exists
    const cameraImage = capturedImage || '';

    // Specific Requirements
    const specificRequirements = document.getElementById('specificRequirements').value;

    // Combine all data
    const formData = {
      generalInfo,
      checkPoints,
      equipmentUsed,
      signatures,
      cameraImage,
      specificRequirements,
      status: 'Open',
      createdAt: new Date().toISOString(),
    };

    console.log('Form Data:', formData); // Log data for debugging

    // Save to DynamoDB
    const params = {
      TableName: 'GeneralPTWIssue', // Replace with your DynamoDB table name
      Item: {
        ptwNumber: ptwNumber,
        formData: formData,
      },
    };

    await dynamodb.put(params).promise();
    ptwForm.reset();
    alert(`PTW successfully submitted with ID: ${ptwNumber}`);
    window.location.href = 'ptw_share.html';
  } catch (error) {
    console.error('Error submitting PTW:', error);
    alert('Error submitting PTW: ' + error.message);
  } finally {
    hideLoading();
  }
}


//*************************************************************************************************************************


// Call functions when document is ready
document.addEventListener('DOMContentLoaded', function() {
  generatePTWNumber(); // Auto-generate PTW number on page load

  // Attach event listener to the form's submit event
  const ptwForm = document.getElementById('ptwForm');
  ptwForm.addEventListener('submit', savePTWFormData);


// Get the dropdown and input elements
    var dropdown = document.getElementById('contractorSupervisor');
    var input = document.getElementById('contractorSupervisorsignature');

    // Add event listener to the dropdown
    dropdown.addEventListener('change', function() {
        // Update the input box with the selected option's text (or value, based on requirement)
        if (dropdown.selectedIndex > 0) { // Check if an option is selected (not the placeholder)
            input.value = dropdown.options[dropdown.selectedIndex].text; // or .value if you need the value instead
        } else {
            input.value = ''; // Clear input if no supervisor is selected (the placeholder option is selected)
        }
    });

// Get the dropdown for requesting personnel and the corresponding input field
    var personnelDropdown = document.getElementById('requestingPersonnel');
    var signatureInput = document.getElementById('requesterSignatureSelect');

    // Add an event listener to the personnel dropdown
    personnelDropdown.addEventListener('change', function() {
        // Set the input field's value to the text of the selected option in the dropdown
        if (personnelDropdown.selectedIndex > 0) { // Ensures that a valid option is selected
            signatureInput.value = personnelDropdown.options[personnelDropdown.selectedIndex].text;
        } else {
            signatureInput.value = ''; // Clear the input if the placeholder or no valid option is selected
        }
    });

});
